<!-- Generated by SpecStory -->

# Adjust text overlay for long text (2025-07-08 10:42Z)

_**User**_

We need to adjust the text overlay for long text.  Users will typically use long text (200-500 characters).

Review the attached image.  The text is in the dark background at the top of the image. With a 200 word text overlay the text needs to be left justified and flow down the length of the image. It needs to be in a column, leaving visible video to the right of the text.
Review the image and devise a fix.

---

_**Assistant**_

Thank you for the detailed description and the image. Here’s a breakdown of the requirements and a plan for the fix:

---

### **Analysis of the Image and Requirements**

- **Current State:**  
  The text overlay appears at the top of the video, spanning the full width, with a dark background. The text is left-justified, but when the text is long, it covers a large portion of the video horizontally, obscuring the content behind it.

- **Desired State:**  
  - For long text (200–500 characters), the overlay should:
    - Be left-justified.
    - Flow vertically (down the image), forming a column on the left.
    - Leave a significant portion of the video visible to the right.
    - The text should not span the full width; instead, it should be constrained to a fixed width (e.g., 30–40% of the video width).
    - The background box should only cover the text area, not the entire width.

---

### **Technical Plan for the Fix**

#### **1. FFmpeg Drawtext Filter Adjustments**

- **Width Constraint:**  
  Use the `drawtext` filter’s `box` and `boxcolor` options, but set the `x` and `y` so the box is only as wide as the text.
- **Text Wrapping:**  
  Manually wrap the text to a maximum number of characters per line, so the text forms a column.
- **Positioning:**  
  Set `x=0` (or a small margin) and `y=0` (or a small margin) to anchor the text to the top-left.
- **Font Size:**  
  Adjust font size so that 200–500 characters can fit vertically within the video height.
- **Box Sizing:**  
  The box should only cover the text, not the full width.

#### **2. Implementation Steps**

- **Text Wrapping Logic:**  
  - Calculate the maximum number of characters per line based on a percentage of the video width (e.g., 30%).
  - Use Python’s `textwrap` to wrap the text accordingly.
- **Drawtext Filter Generation:**  
  - For each line, generate a separate `drawtext` filter, stacking them vertically.
  - Each line’s `y` position is offset by the line height.
- **Left Justification:**  
  - Set `x=margin` (e.g., 30px), `y=margin + line_height * line_number`.
- **Box Color:**  
  - Use `box=1` and `boxcolor=black@0.6` for each line, so the background only covers the text.

---

### **Example FFmpeg Drawtext Filter**

For a video of width 1080px, to use a column of 350px (about 32%):

- **Max chars per line:** Estimate based on font size and width.
- **Sample filter for one line:**
  ```
  drawtext=text='Line 1 text':fontsize=28:fontcolor=white:box=1:boxcolor=black@0.6:x=30:y=30
  drawtext=text='Line 2 text':fontsize=28:fontcolor=white:box=1:boxcolor=black@0.6:x=30:y=30+line_height
  ...
  ```

---

### **Code Changes Needed**

- **In `video_processor.py`**:
  - Update the `_create_multiline_drawtext_filter` method to:
    - Accept a `max_column_width_ratio` (e.g., 0.3 for 30% of video width).
    - Calculate `max_chars_per_line` based on this width and font size.
    - Wrap text accordingly.
    - Stack each line vertically with appropriate `y` offset.
    - Ensure each line’s box only covers the text, not the full width.

---

### **Summary Table**

| Requirement                | Solution Approach                                 |
|----------------------------|---------------------------------------------------|
| Left-justified text        | Set `x` to margin, wrap lines, align left         |
| Column layout              | Limit line width, wrap text, stack lines vertically|
| Background only under text | Use `box=1` per line, not a full-width rectangle  |
| Video visible to right     | Limit text width to 30–40% of video width         |
| Fit 200–500 chars          | Adjust font size and line count to fit vertically |

---

**Next Step:**  
I will update the text overlay logic in `video_processor.py` to implement this columnar, left-justified, non-obscuring style for long text overlays.

Would you like to specify the exact percentage of video width for the text column (e.g., 30%, 35%, 40%), or should I use 30% as a default?

---

